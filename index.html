<body class="app">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pixi.js/5.3.2/pixi.min.js"></script>
    <div class="container">
      <div class="3dcard">
        <script>
          let app = new PIXI.Application({
  width: 768,
  height: 512
});
document.body.appendChild(app.view);

let img = new PIXI.Sprite.from("https://i.imgur.com/6trVFvS.jpg");
img.width = 640;
img.height = 640;
app.stage.addChild(img);

const depthMap = new PIXI.Sprite.from("https://i.imgur.com/1SyBPxz.jpg");
app.stage.addChild(depthMap);

const displacementFilter = new PIXI.filters.DisplacementFilter(depthMap);
app.stage.filters = [displacementFilter];
app.stage.width = 640;
app.stage.height = 640;

window.onmousemove = function (e) {
  displacementFilter.scale.x = (640 / 2 - e.clientX) / 30;
  displacementFilter.scale.y = (640 / 2 - e.clientY) / 30;
};

        </script>
      </div>
      <div class="uploadForm">
        <h1>Upload a portrait photo</h1>
        <form id="uploadForm">
          <input type="file" id="imageInput" accept="image/*" required>
          <div id="imagePreview"></div>
          <input type="text" id="styleInput" placeholder="Enter style" required>
          <button type="submit" id="submitBtn">Upload</button>
        </form>
        <div id="countdown"></div>
      </div>
    </div>
    <script>
      const uploadForm = document.getElementById("uploadForm");
      const imageInput = document.getElementById("imageInput");
      const countdownElement = document.getElementById("countdown");
      const submitBtn = document.getElementById("submitBtn");
      const imagePreview = document.getElementById("imagePreview");
  
      // Image preview
      imageInput.addEventListener("change", function () {
        const file = this.files[0];
        if (file) {
          const reader = new FileReader();
          reader.onload = function(event) {
            imagePreview.style.backgroundImage = `url(${event.target.result})`;
          };
          reader.readAsDataURL(file);
        }
      });
  
      uploadForm.addEventListener("submit", async (e) => {
        e.preventDefault();
        submitBtn.disabled = true;
        submitBtn.innerText = "Processing...";
  
        const style = document.getElementById("styleInput").value;
        console.log(style);  // should log the entered style value
  
        const file = imageInput.files[0];
        if (!file) {
          alert("Please select an image.");
          submitBtn.disabled = false;
          submitBtn.innerText = "Upload";
          return;
        }
  
  
        const formData = new FormData();
      formData.append("face_url", file);
      formData.append("style", style);

  
      const response = await fetch(
  "https://api.magicflow.ai/workflow/f1393464-0252-41f1-ada4-0f42f97c662d/job",
  {
    method: "POST",
    headers: {
      "Authorization": "Token mRrGdHKrm3kDL8t3hl3gKeVsuEsZKbLRU/KlhwjJij94biwkNvfQCmma/xgyRAp2"
    },
    body: formData
  }
);

  
      if (response.ok) {
        const { jobId } = await response.json();
        countdownElement.innerText = "20";
        
        let counter = 20;
        const countdownInterval = setInterval(() => {
          counter--;
          countdownElement.innerText = counter;
          if (counter <= 0) clearInterval(countdownInterval);
        }, 1000);
  
        setTimeout(async () => {
          clearInterval(countdownInterval);
          countdownElement.innerText = "Fetching results...";
          
          const resultResponse = await fetch(
            `https://api.magicflow.ai/workflow/f1393464-0252-41f1-ada4-0f42f97c662d/jobs/${jobId}/results`,
            {
              headers: {
                "Authorization": "Token mRrGdHKrm3kDL8t3hl3gKeVsuEsZKbLRU/KlhwjJij94biwkNvfQCmma/xgyRAp2",
              },
              timeout: 120000 // Set the timeout to 120 seconds (120,000 milliseconds)
            }
          );
  
          if (resultResponse.ok) {
          const results = await resultResponse.json();
          console.log(results); // Process the results as needed
          
          // Assuming results contain the URLs for the new images
          const newImageURL = results['upload-file'];
          const newDepthMapURL = results['upload-depth'];
          
          // Update PIXI.js sprites with new images
          img.texture = PIXI.Texture.from(newImageURL);
          depthMap.texture = PIXI.Texture.from(newDepthMapURL);
        } else {
          console.log("Failed to fetch results.");
        }
      }, 20000);
    } else {
      console.log("Failed to upload image.");
      }

      });
    </script>
    <style>
      .app {
        background: white;
        display: flex;
        align-items: center;
        justify-content: center;
      }
  
      .container {
        display: flex;
        flex-direction: row;
        justify-content: space-around;
        align-items: center;
        width: 100%;
      }
  
     .3dcard {
        flex: 1;
      }
  
      .uploadForm {
        flex: 1;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
      }
  
      #imagePreview {
        width: 100px;
        height: 100px;
        border: 1px solid black;
        background-position: center;
        background-size: cover;
      }
  
      canvas {
        border-radius: 20px;
      }
  
      #uploadForm {
        margin-top: 20px;
      }
    </style>
  </body>
  